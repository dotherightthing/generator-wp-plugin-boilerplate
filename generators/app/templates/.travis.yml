# Configuration file for Travis CI builds,
# which are automatically run when code is pushed to Github.
# To skip a build, add [ci skip] to the commit message.
# This file has been linted using: http://lint.travis-ci.org/

# Use PHP, to use Composer, WordPress and PHPUnit
language: php

# PHP versions to test against
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
php:
  - 5.6.30 # MAMP
#  - 5.5 # Sitehost - fails phpunit version requirement

# Public Environment Variables
# https://docs.travis-ci.com/user/environment-variables
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
env:
  - WP_VERSION=latest WP_MULTISITE=0

# Build Matrix
# consisting of specific runtime/env/exclude/include combinations.
# Each 'include' is run as a separate job.
# https://docs.travis-ci.com/user/customizing-the-build/#Build-Matrix
# https://github.com/meitar/wordpress-plugin-skeleton/blob/master/.travis.yml
matrix:
  # reduce the delay in the build status being reported
  # https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
  fast_finish: true
  include:
    - php: 5.6.30
      env: WP_VERSION=latest WP_MULTISITE=0

# Cache directories between builds, to store dependencies
# which take longer to compile or download.
# https://docs.travis-ci.com/user/caching#Caching-directories-(Bundler%2C-dependencies)
# https://github.com/wp-cli/sample-plugin/blob/master/.travis.yml
# https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
# ~/files - https://blog.wyrihaximus.net/2015/07/composer-cache-on-travis/
cache:
  directories:
#   - node_modules
#   - vendor
#    - $HOME/.composer/cache/files
    - $HOME/.npm 

before_install:
  # Install a Second Programming Language (Node, to run Gulp tasks)
  # We need to specify a newer version than the Travis default
  # in order to avoid the build error "Use of const in strict mode"
  # https://docs.travis-ci.com/user/customizing-the-build/#Installing-a-Second-Programming-language
  # https://stackoverflow.com/a/44250453/6850747
  - nvm install 6.11.2
  # Disable XDebug which is only required for Code Coverage reports
  # https://johnblackbourn.com/reducing-travis-ci-build-times-for-wordpress-projects/
  - phpenv config-rm xdebug.ini
  # Fix PHPDoc error:
  # "Unable to find the `dot` command of the GraphViz package. Is GraphViz correctly installed and present in your path?"
  - sudo apt-get install graphviz

# Install dependencies
# https://docs.travis-ci.com/user/customizing-the-build/#Customizing-the-Installation-Step
# Note: Remember to run composer update on local dev to get latest updates to dependencies
install:
  - composer install --prefer-dist --no-interaction # loads parent plugin class, which in turn runs an install via gulpfile.js
  - npm --prefix ./vendor/dotherightthing/wpdtrt-plugin/ install ./vendor/dotherightthing/wpdtrt-plugin/
  - npm install # child plugin
  - npm install -g bower
# - bower install - run via gulpfile.js
  - npm install -g gulp-cli
  # https://www.sitepoint.com/php-continuous-integration-travis-ci/
  # https://getcomposer.org/doc/03-cli.md

# https://github.com/wp-cli/sample-plugin/blob/master/.travis.yml
before_script:
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - bash bin/install-wp-tests.sh wordpress_test root '' localhost $WP_VERSION

# Run the build script
script:
  - gulp dist --gulpfile ./vendor/dotherightthing/wpdtrt-plugin/gulpfile.js --cwd ./
  - phpunit

# Notifications of build results
# https://docs.travis-ci.com/user/notifications/
notifications:
  email: false
  slack: <%= slackName %>:<%= slackPasswordEncrypted %>

# Deploy code to Github as a 'release'
# This is run after a tagged commit triggers a successful build
# release.zip is generated by gulp dist
# api_key is generated via: travis setup releases
# which requires my GH username and password
# and creates a Personal Access Token at https://github.com/settings/tokens
# named 'automatic releases for <%= githubUserName %>/<%= name %>' 
# https://docs.travis-ci.com/user/deployment/releases/
deploy:
  provider: releases
  api_key:
    secure: W/C0d6kkg6h5+6bQ7S181YlbH45kwOKCq1fo+PS+KIaxAX80NomMo0PAC2h/puNGNeLD5O8knWYcc4tNg059zcGyuf3m6Hs6r959Wlk1RvN3MtdOfm0+Z30xQJEFMuanTSVg1R4lvvKQutADF5T5HT82kjscCzWlFONxsq5kp6/2Z98mN5bCDaQuB2FeyBCCM1TH/OTAtUgdYGQVEJdb1sfv/GLtuYshfLxKycU0bJVo15sOkTyeJM0Qx1CwLovSkpZrqYfrl3vJhDF0MrgI3YKoHFejYXZD4/at5W+buNX95bmXjEI5YLNs2W5GZIi+wUNgJI8qoXxC4pZzc+zxm1ZqaSnYMSOG1HXrZzESbBdUhYbmIU0zuKJnQw8hP1b8GlNruiGrcc4I6iR7yB7OXh9xxyqMWzWgYmhEhGxDQz8wtKvoA/IXKHArfXOasFH+mytFGgwrdLaE9Z5FTRo42DQ/J8td5AzVBl6WVgWHYMJ1zZiGYWllX8oV33kZBUhExqFVe00SksL++HenkDekpUgl7xZQc1Misw5+QemQaIsPMZ5112jSq5uxc2EpWqeTj2lxUWv5ZstZUMt4d+RnDV6o9tPQQh5B3CiZiDHfmLYOMG6O5Zz3Ue3A5OkCSvzVd6cBW3H11NmBQl8rbwhb7Y+WzcXSwPkJLLqeUF/vhs0=
  file: 'release.zip'
  # prevent Travis CI from resetting the working directory
  # which deletes all changes made during the build 
  skip_cleanup: true
  on:
    repo: <%= githubUserName %>/<%= name %>
    tags: true
    # https://stackoverflow.com/a/27775257/6850747
    all_branches: true
